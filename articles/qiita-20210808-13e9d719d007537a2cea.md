---
title: "ã€Laravelã€‘APIãƒ†ã‚¹ãƒˆã§è‡ªåˆ†ã§ç”¨æ„ã—ãŸãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚"
emoji: "ğŸ—³"
type: "tech"
topics: [PHP,test,åˆå¿ƒè€…,Laravel]
published: true
---
## èƒŒæ™¯

Laravelã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹éš›ã«ã¯`UploadedFile::fake()`ã§ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚[^1]

```php
    public function test_import_success()
    {
        Excel::fake();
        Storage::fake();

        $response = $this->post(route('users.excel.import.upload'), [
            'users' => UploadedFile::fake()->create(
                name: 'users.xlsx',
                mimeType: 'application/vnd.openxmlformats-officedocument.spread'
            )
        ]);

        $response->assertOk();
    }
```

ã—ã‹ã—ã€CSVã‚„ã‚¨ã‚¯ã‚»ãƒ«ã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹APIã®ãƒ†ã‚¹ãƒˆæ™‚ã«ã¯ã€è‡ªåˆ†ã§ç”¨æ„ã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ã€‚

æ¤œç´¢ã—ãŸãŒæ—¥æœ¬èªã§ã¯ãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚[^2]

## å®Ÿè£…

`Illuminate\Http\UploadedFile`ã‚’ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¸­ã§newã—ã¦ã‚ã’ã‚Œã°è‰¯ã„ã€‚

```php
    public function test_import_success()
    {
        $response = $this->post(route('users.excel.import.upload'), [
            'users' => new UploadedFile(
                './tests/Feature/data/import_success.xlsx',
                'import_success.xlsx',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                null,
                true
            )
        ]);

        $response->assertOk();
    }
```

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å¼•æ•°ã¯`Illuminate\Http\UploadedFile`ã®ç¶™æ‰¿å…ƒã§ã‚ã‚‹`Symfony\Component\HttpFoundation\File\UploadedFile`ã®[ã‚½ãƒ¼ã‚¹](https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/HttpFoundation/File/UploadedFile.php)ã‚’å‚ç…§ã™ã‚‹ã¨èª¬æ˜ãŒæ›¸ã„ã¦ã‚ã‚‹ã€‚

```php:Symfony\Component\HttpFoundation\File\UploadedFile.phpï¼ˆæŠœç²‹ï¼‰
     * @param string      $path         The full temporary path to the file
     * @param string      $originalName The original file name of the uploaded file
     * @param string|null $mimeType     The type of the file as provided by PHP; null defaults to application/octet-stream
     * @param int|null    $error        The error constant of the upload (one of PHP's UPLOAD_ERR_XXX constants); null defaults to UPLOAD_ERR_OK
     * @param bool        $test         Whether the test mode is active
     *                                  Local files are used in test mode hence the code should not enforce HTTP uploads
```

æ³¨æ„ã™ã‚‹ã¹ãç‚¹ã¯2ã¤

- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—çŠ¶æ…‹ã‚’å†ç¾ã—ãŸã„å ´åˆã¯`$error`ã«`UPLOAD_ERR_NO_FILE`ç­‰ã®PHPå®šç¾©æ¸ˆã¿å®šæ•°ã‚’å®šç¾©ã—ã¦ã‚ã’ã‚‹ã€‚
- ãƒ†ã‚¹ãƒˆæ™‚ã«`$test`ã¯`true`ã«ã™ã‚‹ã€‚ â€»è©¦ã—ã«falseã«ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒAPIã«æ¸¡ã•ã‚Œãªã„æ¨¡æ§˜

## çµè¨€

ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã‚’ç°¡å˜ã«ã‚ãã‚‰ã‚ãªã„ã§
â€»è¨˜äº‹ã¸ã®ã”æŒ‡æ‘˜æ­“è¿ã„ãŸã—ã¾ã™ã€‚

[^1]: https://laravel.com/docs/8.x/http-tests#testing-file-uploads
[^2]: è‹±èªã§ã¯[stackoverflow](https://stackoverflow.com/questions/36408134/how-to-test-file-upload-in-laravel-5-2)ã®è¨˜äº‹ãŒå­˜åœ¨ã™ã‚‹ã€‚

