---
title: "Amazon Cognito User Poolã‚’æœ¬ç•ªå°å…¥ã™ã‚‹ã¨ãã¯ã€é•·ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ³¨æ„"
emoji: "ğŸ“§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "cognito", "email", "authentication"]
published: false
---

## èƒŒæ™¯

Amazon Cognito User Pool ã¨ã„ã†èªè¨¼èªå¯ã‚’è‚©ä»£ã‚ã‚Šã—ã¦ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«æœ¬ç•ªå°å…¥ã—ãŸã€‚

ã„ã–ãƒªãƒªãƒ¼ã‚¹ã¨ãªã‚Šã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã„ã‚‹ã¨ã€Œã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã£ã¦ email ã®æ–‡å­—åˆ¶é™ã©ã†ãªã£ã¦ã‚‹ã‚“ã ã£ã‘?ã€ã¨ãªã‚Šæ¤œè¨¼ã®ãƒ¡ãƒ¢ã‚’æ®‹ã™ã€‚

## å‰æ

### Cognitoã®Admin Create Userã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’è¡Œã†ã“ã¨ã€‚

é–‹ç™ºæ™‚ã¯ã€Hosted UIçµŒç”±ã®ç™»éŒ²ãŒãƒ¡ã‚¤ãƒ³ã§ãªãã€APIçµŒç”±ã§ç™»éŒ²ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã ã£ãŸã€‚

ã“ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¯ã€èª°ã§ã‚‚ç™»éŒ²ã§ããªã„ç®¡ç†ç”»é¢ç³»ã®é–‹ç™ºã§ã¯å¤šã„ã¨æ€ã†ã€‚ (ç‰¹ã«ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç³»)

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚

![ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šç”»é¢](/images/20250824-cognito-long-email/cognito-signin-options.png)

:::message
â€» Hosted UIã§Emailã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã•ã›ãŸã„å ´åˆã¯ã€ä¸Šè¨˜ã®è¨­å®šã§ãªã„ã¨ã§ããªã‹ã£ãŸã€‚
â€» ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -> ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã®å¿…é ˆå±æ€§ -> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã¨ã€ãã‚‚ãã‚‚Hosted UIã§Emailãƒ­ã‚°ã‚¤ãƒ³ãŒã§ããªã„ã€‚(è©¦ã—ãŸé™ã‚Šã¯)
:::

:::message
User Poolã‚’ä¸€åº¦ä½œæˆã™ã‚‹ã¨ã“ã®å±æ€§ã¯å¤‰ãˆã‚‰ã‚Œãªã„ã®ã§ã€æ³¨æ„ã™ã‚‹ã“ã¨ã€‚
:::

terraformã§ã®è¨­å®šæ–¹æ³•ã¯ä¸‹è¨˜ã€‚

```hcl
resource "aws_cognito_user_pool" "example" {
  name = "example-user-pool"
  username_attributes = ["email"]
}
```

## ç™ºç”Ÿäº‹è±¡

### Admin Create Userã§ã¯ 128 æ–‡å­—ã‚’è¶…ãˆã‚‹Emailã‚’ç™»éŒ²ã§ããªã„ã€‚

ã‚µã‚¤ãƒ³ã‚¤ãƒ³è­˜åˆ¥å­ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã™ã‚‹ã¨ã€User Poolå†…éƒ¨ã§ã¯ usernameãŒemailã¨åŒç­‰ã¨ã¿ãªã•ã‚Œã‚‹ã€‚

ã—ã‹ã—usernameã¯128æ–‡å­—ä¸Šé™ã®ãŸã‚ã€ãã‚Œã‚’è¶…ãˆã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã§ããªã„ã€ã€ã€

```bash
# 254æ–‡å­—ã®email(RFCä¸Šé™)ã®Emailã‚’ä½œæˆ
aws cognito-idp admin-create-user \
  --user-pool-id ap-northeast-1_E8sXPyQA5 \
  --username "$(printf 'a%.0s' {1..242})@example.com" \
  --user-attributes Name=email,Value="$(printf 'a%.0s' {1..242})@example.com"

# ã‚¨ãƒ©ãƒ¼: Member must have length less than or equal to 128
```

## å›é¿æ–¹æ³•

### UpdateUserAttributes ã‚’ä½¿ã„ã€ç™»éŒ²å¾Œã«æ‰‹å‹•æ›´æ–°ã™ã‚‹

ä¸Šè¨˜äº‹è±¡ã®ãŸã‚ã€(APIçµŒç”±ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã™ã‚‹å ´åˆ) ã¾ãšã¯ãƒ€ãƒŸãƒ¼emailã§ç™»éŒ²ã—ã¦ã‹ã‚‰ã€æ›´æ–°ã‚’ã‹ã‘ã‚‹ã€‚

```bash
# 1. çŸ­ã„emailã§ä½œæˆ
aws cognito-idp admin-create-user \
  --user-pool-id ap-northeast-1_E8sXPyQA5 \
  --username "temp@example.com" \
  --user-attributes Name=email,Value="temp@example.com"

# 2. 254æ–‡å­—emailã«æ›´æ–°ï¼ˆemail_verifiedã¨åŒæ™‚è¨­å®šãŒå¿…é ˆï¼‰
aws cognito-idp admin-update-user-attributes \
  --user-pool-id ap-northeast-1_E8sXPyQA5 \
  --username [UUID] \
  --user-attributes \
    Name=email,Value="$(printf 'k%.0s' {1..242})@example.com" \
    Name=email_verified,Value=true # email_verified ã‚’trueã«ã—ãªã„ã¨æ›´æ–°ã•ã‚Œãªã„ã®ã§æ³¨æ„
```

æ³¨æ„äº‹é …ã¨ã—ã¦ã¯

1. email_verified ã‚’trueã«ã—ãªã„ã¨æ›´æ–°ã•ã‚Œãªã„ã®ã§æ³¨æ„
1. é•·ã„emailã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ¤œç´¢ã¯Admin Get User APIã®æ¤œç´¢æ–‡å­—åˆ—é•·ä¸Šé™(128æ–‡å­—)ã«å¼•ã£ã‹ã‹ã‚‹ãŸã‚ã€subã‚’æŒ‡å®šã™ã‚‹ã‹ã€List Users APIã§å‰æ–¹ä¸€è‡´æ¤œç´¢ã‚’æ›ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹

## ã¾ã¨ã‚

ãã‚‚ãã‚‚254æ–‡å­—è¿‘ãã®emailã¯(é€šå¸¸ã®é–‹ç™ºã§ã¯)ã»ã¼å­˜åœ¨ã—ãªã„ã¯ãšã€ã€ã€

â€»ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒ¼ãƒˆãŒ64æ–‡å­—ä¸Šé™ãªã®ã§ãã‚‚ãã‚‚100æ–‡å­—ç¨‹åº¦ã«ã—ã‹ãªã‚‰ãªã„

ãªã®ã§Cognitoå°å…¥æ™‚ã¯ã€Emailæ–‡å­—é•·ä¸Šé™ã‚’usernameã¨åŒç­‰ã«128æ–‡å­—ã§çµ„ã‚€ã®ãŒè‰¯ã„ã ã‚ã†ã€‚

## æ„Ÿæƒ³

Cognitoã®å°å…¥ç†ç”±ã¨ã—ã¦ã¯ã€AWSã«é–‰ã˜ã‚‰ã‚Œã‚‹ã“ã¨ã€ä¾¡æ ¼ãŒå®‰ã„ã“ã¨ã€ãªã©ã‚ã‚‹ãŒç´°ã‹ã„APIã‚»ãƒƒãƒˆã®IFã«ãƒãƒã‚Šã©ã“ã‚ãŒå¤šãã€ã‚„ã¯ã‚Šä¾¡æ ¼ãªã‚Šãªã®ã‹ãªã¨æ„Ÿã˜ã¦ã—ã¾ã£ãŸã€‚

ã—ã‹ã—æœ€è¿‘ã¯Hosted UIã®æ—¥æœ¬èªå¯¾å¿œãªã©ã€å¤§ããªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚‚ã‚ã‚‹ãŸã‚ã€ä»Šå¾Œã«æœŸå¾…ã—ãŸã„ã€‚

ä»¥ä¸Šã€‚