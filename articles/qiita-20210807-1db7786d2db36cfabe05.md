---
title: "ã€Laravel8ãƒ»PHP8ã€‘PHPUnitã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¸­ã§seedingã™ã‚‹ã¨ã€ŒPDOException Ther"
emoji: "ğŸ˜€"
type: "tech"
topics: [PHP,MySQL,Laravel,PHP8,laravel8]
published: false
---
## èƒŒæ™¯

ãƒ†ã‚¹ãƒˆã§ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã«ãªã£ãŸã€‚

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸­ã§ã‚·ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã¨ãã«è©°ã¾ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚

## ç’°å¢ƒ

- Laravel 8.40
- PHP 8.0
- MySQL 8.0

## äº‹è±¡

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¸­ã§ã‚·ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ

```
$ php artisan test ./tests/Unit/UserTest.php 

   FAIL  Tests\Feature\UserTest
  â¨¯ seed

  ---

  â€¢ Tests\Feature\UserTest > seed
   PDOException 

  There is no active transaction

  at vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:279
    275â–•      */
    276â–•     protected function performRollBack($toLevel)
    277â–•     {
    278â–•         if ($toLevel == 0) {
  âœ 279â–•             $this->getPdo()->rollBack();
    280â–•         } elseif ($this->queryGrammar->supportsSavepoints()) {
    281â–•             $this->getPdo()->exec(
    282â–•                 $this->queryGrammar->compileSavepointRollBack('trans'.($toLevel + 1))
    283â–•             );


  Tests:  1 failed
  Time:   0.39s
```

### å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰

```php:UsersTableSeeder
<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;

class UsersTableSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * @return void
     */
    public function run()
    {
        DB::table('users')->truncate();

        DB::table('users')->insert([
            'id' => 1,
            'name' => 'test name 1',
            'email' => 'test1@test.com',
            'email_verified_at' => now(),
            'password' => \Hash::make('password'),
            'remember_token' => Str::random(10),
        ]);
    }
}
```

```php:UserTest.php
<?php

namespace Tests\Unit;

use Database\Seeders\UsersTableSeeder;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class UserTest extends TestCase
{
    use RefreshDatabase;

    public function test_seed()
    {
        $this->seed(UsersTableSeeder::class);

        $this->assertDatabaseHas('users', [
            'id' => 1,
            'name' => 'test name 1',
            'email' => 'test1@test.com',
        ]);
    }
}
```

## è§£æ±ºç­–

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸­ã§ä½¿ã£ã¦ã„ã‚‹Traitã‚’`RefreshDatabase` ã‹ã‚‰ `DatabaseMigrations` ã«å¤‰ãˆã‚‹ã€‚

### ã‚³ãƒ¼ãƒ‰
```php:UserTest.php
<?php

namespace Tests\Unit;

use Database\Seeders\UsersTableSeeder;
use Illuminate\Foundation\Testing\DatabaseMigrations;
use Tests\TestCase;

class UserTest extends TestCase
{
    use DatabaseMigrations;

    public function test_seed()
    {
        $this->seed(UsersTableSeeder::class);

        $this->assertDatabaseHas('users', [
            'id' => 1,
            'name' => 'test name 1',
            'email' => 'test1@test.com',
        ]);
    }
}
```

### çµæœ

```
$ php artisan test ./tests/Unit/UserTest.php 

   PASS  Tests\Feature\UserTest
  âœ“ seed

  Tests:  1 passed
  Time:   0.42s
```

## èª¿æŸ» (WIP

æ¤œç´¢ã—ã¦ã¿ã‚‹ã¨Laravelã‚„PHPã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³èµ·å› ã«ã‚ˆã‚‹ã‚‚ã®ï¼Ÿ

åŒæ§˜ãªã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦è­°è«–ã—ã¦ã„ã‚‹Issueã‚’ç™ºè¦‹

https://github.com/laravel/framework/pull/35988

[ã‚³ãƒ¡ãƒ³ãƒˆ](https://github.com/laravel/framework/pull/35988#issuecomment-765119123)ã«ã¯ã“ã®ä¸€æ–‡ãŒ


>Before PHP 8, while there's no active transaction PDO doesn't throw any error but this not the same in PHP 8.

ã¤ã¾ã‚Š8ç³»ä»¥å‰ã§ã‚‚åŒæ§˜ã®äº‹è±¡ã¯ç™ºç”Ÿã—ã¦ã„ãŸãŒã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã‹ã£ãŸã ã‘ã¨è€ƒãˆã‚‰ã‚Œã‚‹ã€‚

ãã®äº‹è±¡ãŒãªãœèµ·ãã‚‹ã‹ã«ã¤ã„ã¦ã¯èª¿æŸ»ä¸­
â€»[MySQLã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://dev.mysql.com/doc/refman/8.0/en/implicit-commit.html)ã«ã¯Truncateã¯æš—é»™çš„ã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚‹ã‚ˆã†ãªã®ã§ã“ã‚ŒãŒé–¢ä¿‚ã—ã¦ã„ã‚‹ï¼Ÿ
â€»[Laravelã®issue](https://github.com/fisharebest/webtrees/issues/3856)ã§ä¿®æ­£ã«ã¤ã„ã¦ã¯è­°è«–ã•ã‚Œã¦ã„ã‚‹æ¨¡æ§˜

## è£œè¶³

é–“é•ã„ç­‰ã®ã”æŒ‡æ‘˜æ­“è¿ã„ãŸã—ã¾ã™ã€‚


